# Данни {#data} 

Тази част от ръководството представя възможностите на R за  четене и записване на данни в различни формати. Разгледани популярни източници на статистически данни, като специално внимание е обърнато на източниците съдържащи данни за България.  

- Статистическа служба към Европейската комисия (Евростат) <https://ec.europa.eu/eurostat/data/database>   
- Статистическата база данни на Европейската централна банка (ECB) <https://sdw.ecb.europa.eu/>   
- Националния статистически институт (НСИ) <https://www.nsi.bg/>  
- Българска народна банка (БНБ) <https://www.bnb.bg/>  
- Портал за отворени данни  <https://data.egov.bg/>  

Направен е кратък преглед на два основни стандарта предназначени за пренос на данни, _Съвремени решения за обмен на статистически данни_ [@Velkov2009],  това са Стандарта за обмен на статистически данни и мета данни (SDMX –Statistical Data and Metadata eXchange) и Разширеният език за бизнес отчетност (Extensible Business Reporting Language - XBRL), които широко използвани при обменна на статистически данни. Разглежданите стандарти са насочени съответно предимно към обмена на агрегирани статистически данни - SDMX и докладването на индивидуални бизнес данни - XBRL, но могат да имат и по-широко приложение, поради лесната им интерпретация за конкретните бизнес нужди. 



## Четене на таблични данни {#tab-data} 

 _Препоръката на W3C от 17 декември 2015_ [@W3Ctab], дефинира табличните данни по следния начин:  

>Табличните данни са данни, които са структурирани в редове, всеки от които съдържа информация за дадено явление. Всеки ред съдържа еднакъв брой клетки (въпреки че някои от тези клетки може да са празни), които предоставят стойности за дадена характеристика на явлението, описана от реда. При таблични данни, клетките в една и съща колона предоставят стойности за една и съща характеристика на явлението описана на реда. 

Има различни формати използвани за обмена на таблични данни в уеб пространството, като често използвани такива са:   

- *Comma-separated values (CSV)* - текстови файлове чиито стойности са разделени с запетая.  

- *Тab-separated values (TSV)* - текстови файлове чиито стойности са разделени с табулатор.  

- *Електронни таблици (spreadsheets)* създадени със специализиран приложен софтуер за работа с таблични данни, като Open Office Calc,  MS Excel, Google Sheets  и други.  

- *HTML таблици* - HTML структори за таблично представяне на данни в уеб страници.

### Comma-separated values (CSV) {#tab-data-csv}  

Всеки работен ден БНБ публикува на [интернет страницата си ](https://www.bnb.bg/Statistics/StExternalSector/StExchangeRates/StERForeignCurrencies/index.htm)  курсове на българския лев към отделни чуждестранни валути. Данните могат да се изтеглят в xls, pdf, xml или csv формат. Примера функцията  **read.csv()** включена в базовия пакет **utils** за да прочете данните за курса към долара за месец януари 2020 г. в csv формат.

```{r readcsv}
url_file_path <- "https://www.bnb.bg/Statistics/StExternalSector/StExchangeRates/StERForeignCurrencies/index.htm?downloadOper=true&group1=second&periodStartDays=01&periodStartMonths=01&periodStartYear=2020&periodEndDays=31&periodEndMonths=01&periodEndYear=2020&valutes=USD&search=true&showChart=false&showChartButton=true&type=CSV"
bnb_cr_usd_data <-  read.csv(url_file_path, header= FALSE, skip = 2)

```

Пакета **utils** е част от системните библиотеки в R и няма нужда предварително да бъде зареден в паметта чрез **library()**. При зададените параметри *header= FALSE, skip = 2*, функцията **read.csv()** връща резултата с автоматично зададени имена на колоните. Използваната функцията е разновидност на **read.csv()** предназначена за текстови файлове чиито стойности са разделени с запетая.

```{r readcsv_print}
bnb_cr_usd_data

```

Пoради това, че файла който се изтегля от страницата на БНБ има четири разделителя (,), резултата върнат функцията **read.csv()** от e "data.frame" с пет колони, последатта от който не съдържа никакви стойности.  




### Тab-separated values (TSV) {#tab-data-tsv} 

Статистическа служба към Европейската комисия (Евростат) има богата база от набори данни по различни теми, които могат да се изтеглят в TSV формат. Примера използва данните за *Държавния дефицит/излишък, държавния дълг и свързани с тях данни (GOV_10DD_EDPT1)* и функцията **read_tsv()** от пакета **readr**.


```{r message=FALSE}
library(readr)

url_file_path <- "https://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing?file=data/gov_10dd_edpt1.tsv.gz"
estat_gov_10dd_edpt1_data <- read_tsv(url_file_path) 
```

Изпълнението на кода извиква следното съобщение:  

```{r echo=FALSE}

url_file_path <- "https://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing?file=data/gov_10dd_edpt1.tsv.gz"
estat_gov_10dd_edpt1_data <- read_tsv(url_file_path) 
```


Данните за  *Държавния дефицит/излишък, държавния дълг и свързани с тях данни (GOV_10DD_EDPT1)* са структурирани по следния начин, в първата колона са кодовете на показателите получени като сечение на кодовете от номенклатурите *unit*, *sector*, *na_item*, *geo* разделени с запетая,като данните за периодите (*time*) са в отделни колони. Тези номенклатури могат също могат да бъдат изтеглени от сайта на ЕВРОСТАТ, чрез функцията **read_tsv()**:  

```{r message=FALSE}

url_file_path <- "https://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing?file=dic/en/unit.dic"
estat_unit_dic <- read_tsv(url_file_path, col_names = c("Code", "Description"))

url_file_path <- "https://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing?file=dic/en/sector.dic"
estat_sector_dic <- read_tsv(url_file_path, col_names = c("Code", "Description"))

url_file_path <- "https://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing?file=dic/en/na_item.dic"
estat_na_item_dic <- read_tsv(url_file_path, col_names = c("Code", "Description"))

url_file_path <- "https://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing?file=dic/en/unit.dic"
estat_geo_dic <- read_tsv(url_file_path, col_names = c("Code", "Description"))

```

Файловете с номенклатурите (.dic) имат по две колонни, като първата съдържа кода, а в втората е неговото описание.  В примера се използва аргумента **col_names** на функцията **read_tsv()** за да се дадат имена на тези колонни, защото във входните файлове колоните нямата имена. Помощна информация за функцията може да получите чрез извикаване на командата read_tsv *?read_tsv*.  

Пакета readr има пет функции за таблични данни:

- **read_csv()** и **read_csv2()** за csv файлове
- **read_tsv()** за файлове използващи таболатор за разделител.
- **read_fwf()** за fixed-width файлове
- **read_log()** за log файлове

И петте функции за четене на таблични данни в пакета използват функцията **spec_xxx()** за да определи спецификацията на колоните във входния файл. 

По подразбиране **readr** разглежда първите 1000 реда за да определи типа на колоната, това помага бързото парсиране на файлове, но може да генерира неправилни резултати. В примера определя три от колоните като *double*, а останалите като *character* поради наличието на символа двоеточие (:) с които са обозначени липсващите наблюдение за годините преди 2016. 



### Електронни таблици (spreadsheets) {#tab-data-spreadsheets}

В примера ще използваме данните в справката *Депозити на нефинансови предприятия, финансови предприятия И домакинства и НТООД по количествени категории (dep_dyn_qcat_bg)* от [статистиката на депозити и кредити по количествени категории и икономически дейности](https://www.bnb.bg/Statistics/StMonetaryInterestRate/StDepositsAndCredits/StDCDeposits/StDCDepositsDataSeries/index.htm) публикувана от БНБ. Функцията **read_excel** от пакета **readxl** не може да чета данните от url, поради това в примера се използва пакета **httr** за да направим HTTP GET заявка към уеб адреса и да запишем съдържанието на отговора във временен файл. 

```{r tab-data-spreadsheets_1, message=FALSE}

library(readxl)
library(httr)

url_address <- "https://www.bnb.bg/bnbweb/groups/public/documents/bnb_download/dep_dyn_qcat_bg.xlsx"
writeBin(content(GET(url_address), "raw"), file.path(tf <- tempfile(fileext = ".xlsx")))
bnb_dep_dyn_qcat_bg <- read_excel(tf, skip = 1)

rm(tf)
```


Предварителния преглед на данните е показал, че първия ред е заглавието на таблицата, поради което използваме аргумента *skip* за да го пропуснем. На този етап се абстрахираме от факта, че данните не са добре структурирани (има слети клетки, колони без имена) за машина обработка, като в следващите част на ръководството ще покажем как тези недостатъци могат да бъдат коригирани.  

```{r tab-data-spreadsheets_2, include = FALSE}
rm(tf)
```

## Четене на уеб базирани данни {#web-data} 


Примера разгледан в т. 2.1.3 показа, че не винаги можем да използваме желаната от нас функция за да четем данните директно от уеб (url). Това налага, понякога, да свалим данните локално преди да използваме необходимата ни функция. В примера използвамхме за целта пакета [httr](https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html). но самия пакет е проектиран да създаде съответствие с HTTP протокола и има по-големи възможности.

Например да видим заглавната част на отговор получен в следствие на направената GET заявка:

```{r tab-data-web-data1}
headers(GET(url_address))
```


## Стандартът SDMX {#sdmx-data} 




TODO

### За SDMX {#sdmx-data_about}

Стандарта за обмен на статистически данни и мета данни (SDMX – Statistical Data and Metadata eXchange) е създаден благодарение на международна инициатива целяща разработването и въвежданите на по ефективни процеси при обмена и споделянето на статистически данни между международните организации и техните членки. Инициативата стартира през 2001 г. с подкрепата на 7 международни организации.

Банката за международни разплащания (БМР), Европейската централна банка  (ЕЦБ), ЕВРОСТАТ, Международния валутен фонд (МВФ), Организацията за икономическо сътрудничество и развитие (ОИСР), Обединените нации (ОН) и Световната банка(СБ).  

Много международни институции, национални статистически институции, централни банки предлагат на своите интернет страници данни в SDMX формат, поради което в частта са представени подробности за стандарта.  

Стандартът за обмен на статистически данни и мета данни не е просто формат за пренос на данни, той представлява завършен модел за пренос едновременно на данни и мета-данни и синтаксис, предоставящ възможността за автоматичен обмен. 

Стандартът използва дефинира различни формати за обмен на статистически данни. Във версия 2.1 на стандарта, основния формат е SDMX–ML, базиран на доказалия своите качества XML. В версия на стандарта продължа да се поддържа формата SDMX – EDI (преди наричан GESMES/TS), но все повече иституции преминават към SDMX-ML, SDMX-JSON или SDMX-CSV.   

Стандартът е създаден и предназначен основно за обмена и споделянето на агрегирани статистически данни (макро данни), въпреки това е приложим и за обмена на индивидуални статистически данни (микро данни). Стандартът позволява обмена както на временни редови, така и за многомерно разпределени данни.
В основата на стандарта стои неговия информационен модел представляващ абстрактна статистическа концепция. Модела е основен компонент при практическото използване на стандарта. В модела данните (и отнасящи се към тях мета-данни) за отделен вид статистика се структурират в статистическо множество чрез Структурна дефиниция на данните (Data Structure Definition - DSD) . Данните трябва се асоциират със структурните мета-данни, което прави възможно идентифицирането, намирането и прегледа на необходимата информация. Структурните мета-данни обхващат структурните дефиниции, статистическите концепции и списъците с кодове. Структурните мета-данни са мета - данни служещи за идентифициране и описание на статистическите данни. Структурната дефиниция описва структурата на дадено статистическо множество чрез списък от дименсии (например: честота, държава и т.н.) и атрибути (например: мерна единица, поверителност и т.н.) и отнасящите се към тях списъци от кодове. 
Дименсиите за дадено статистическо множество се групират в ключове които позволяват да се индетифицира даден набор от данни (например отделен временен ред). Всяка стойност на отделните дименсии в ключа принадлежи на съответния списък от кодове. 
В информационния модел атрибутите са мета-данни за индивидуална стойност, временен ред или група от временни редове. Атрибутите могат бъдат както кодирани, т.е. да принадлежат на даден списък от кодове или да бъдат и свободен текст. Това е така понеже предназначението на атрибутите е да описват, а не да идентифицират данните. 
Списъците от кодове представляват номенклатурата от възможни стойности на дадена дименсия (представляваща статистическо понятие). Всяка стойност в даден списък от кодове представлява езиково независим код с описание, като към всеки код се подържат описания на различни езици.
Стандарта дефинира също така и модела за допълнителни обяснителни мета-данни, който често се наричат референтни мета-данни. Тези мета-данни в общия случай представляват текст използващ статистически понятия (концепции) за описание на съдържанието, методологията и качеството на данните. Референтните мета-данни за отделен вид статистика или статистически поток от данни се структурират в  Структурна дефиниция на мета- данните (Metadata Structure Definition - MSD). Референтните мета-данни, са мета-данни описващи съдържанието и качеството на статистическите данни, това са концептуални, методологически и отнасящи се да качеството на информацията мета-данни, описващи съответно концепциите използвани при практическото изготвяне на статистиките, методите използвани за генериране на данните и различните качествени характеристики на получените данни.
Международните организации са създали голяма количество структурни дефиниции обслужващи докладването на необходимите им данни. Тези структурни мета-данни са свободни за използване и могат да бъдат лесно адаптирани за специфичните нужди на всяка организация получаваща и разпространяваща статистически данни. В допълнение всяка организация желаеща да използва стандарта може да разработва собствени структурни дефиниции отговарящи на нуждите на конкретните потоци от данни.   
SDMX-ML синтаксиса на стандарта предлага четири различни формата за представяне на данните, еквивалентни по същество, но различаващи се обективно от гледна точка нивото на свързаност със структурните дефиниции на данните (Data Structure Definitions - DSD), валидизацията и начина на представяне на данните. SDMX-ML синтаксиса позволява стандарта да се използва  включително и за многомерно разпределени данни. В общия случай конверсията между различните формати е възможна, като за целта са разработени и безплатни приложения.  
Хармонизация на статистическия процес на национална и над национално ниво е едно от най- големите предизвикателства пред съвременната статистика. Поради тази причина основно място в стандарта заема използването на общи понятията в различни статистически области, т.н. крос- областни понятия. В настоящия момент стандарта съдържа 135 понятия и под понятия. Крос- областни понятия се използват основно като структурни мета- данни в Структурните дефиниции на данните (например: честота, референтна област и валута) и в Структурните дефиниции на мета-данните като понятия служещи за измерване и определяне на качеството на данните (например: точност, сравнимост и  навременност).   Т. е. крос- областни понятия в стандарта имат две различни предназначения: Първото като структурни мета-данни (дименсии) в структурните дефиниции на данните за идентифициране на отделните статистически наблюдения. И второ като референтни мета-данни (атрибути) в структурни дефиниции на мета- данните предоставяйки информация за класифициране на данните. Стойността на понятията може да бъде кодирана, но в много случай е свободен текст.   Използването на хармонизиран понятиен апарат позволява статистическите организации да измерват и анализират качеството през целия статистически процес.


### Четене на SDMX {#sdmx-data_read} 


## Разширения език за бизнес отчетност {#xbrl-data} 

TODO

### За XBRL {#xbrl-data_about}  

Разширеният език за бизнес отчетност (Extensible Business Reporting Language - XBRL) е електронен език (XML-език) предоставящ независима платформа за дефиниране, обемен и разпространение на докладваната бизнес информация. Езикът е  създаден от международен консорциум състоящ се от около 550 големи компании, организации и правителствени агенции. Езикът представлява отворен стандарт, достъпен за използване без да се заплащат лицензни такси. Езикът е силно подържан и налаган от  различни софтуерни разработчици, което е довело до силното обвързване на езика с тези разработчици.  

Използването на XBLR позволява увеличаване на скоростта при обмена на данни, намалява възможностите за грешки и позволява автоматичната проверка на информацията, позволявайки по тази начин да се  намалят разходите и да създаде общ поток обхващащ процесите по събиране и докладване на информация.  

Ключовото понятия в Разширеният език за бизнес отчетност са таксономии. XBRL e платформа, която се използва от различни програмни продукти, но за да се структурира отчетната информация, се въвеждат така наречените таксономии. Таксономията осигурява структурирането на данните и връзките между тях. Таксономията представлява класификатор на отделните елементи (факти) на даден отчет, като в нея също се задават и логическите връзки и зависимости между тях. Таксономиите се описват в отделни документи (XML – схеми), които съдържат информация за структурата, езика, йерархията и връзката между фактите.  

Членовете на XBRL консорциума са разработили някой базови таксономии описващи финансовите факти. Тези базови таксономии могат да бъдат разширявани, така, че да отговарят на специфични нужди (например според нуждите на националните статистики или на отделена статистическа организация). Алтернативна възможност на разширяването на съществуващите таксономии е създаването нови. Различни организации, могат да създават собствени таксономии покриващи нуждите на тяхната собствена отчетност, като за отделните видове отчетност се създават отделни XBRL таксономии. Впоследствие създадените нови таксономии да бъдат свързани към съществуващите.  

### Четене на XBRL {#xbrl-data_read} 



## Оптичното разпознаване на символи (OCR) {#ocr-data}




TODO





## Извличане данни от уебсайтове (Web Scraping) {#web_scraping-data}
 
Според предварителните познания за структурата и съдържанието на уебсайтове,  може да се разграничат два вида извличане на данни:  
https://webgate.ec.europa.eu/fpfis/mwikis/essnetbigdata/images/2/27/BDES_2018_WP2_Presentation.pdf  


*Специфично* – когато като структурата, така и съдържание на уеб сайтовете са напълно известни.

*Общо* – когото не са налични априорни познания за структурата и съдържанието, поради което цялото съдържание на уебсайтове трябва да бъде извлечено и обработено за може да се направи извод за съответната информация.


